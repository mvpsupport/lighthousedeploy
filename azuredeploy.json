{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "targetSubscriptions": {
      "type": "array",
      "metadata": {
        "description": "Array of subscription IDs that will receive the Lighthouse delegation."
      }
    },
    "mspOfferName": {
      "type": "string",
      "metadata": {
        "description": "Provide a name for this registration definition. For example the name of the Managed Service Provider's offer."
      }
    },
    "mspOfferDescription": {
      "type": "string",
      "metadata": {
        "description": "Provide a description for this registration definition. For example contact or contract details."
      }
    },
    "managedByTenantId": {
      "type": "string",
      "metadata": {
        "description": "Specify the Azure Active Directory tenant id of the Managed Service Provider. Resources will be shared to this tenant."
      }
    },
    "authorizations": {
      "type": "array",
      "metadata": {
        "description": "Array of objects containing principalId, roleDefinitionId, and optional principalIdDisplayName."
      }
    },
    "marketplaceOffer": {
      "type": "string",
      "defaultValue": "No",
      "metadata": {
        "description": "Does this deployment include plan details that match an offer published in the Azure Marketplace?"
      }
    },
    "marketplacePublisherId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Must match the Azure Marketplace Publisher ID for the marketplace offer."
      }
    },
    "marketplaceOfferId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Must match the Azure Marketplace Offer ID for the marketplace offer."
      }
    },
    "marketplacePlanId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Must match the Azure Marketplace Plan ID for the plan within the marketplace offer."
      }
    },
    "marketplacePlanVersion": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Must match the Azure Marketplace Plan version for the plan within the marketplace offer."
      }
    },

    "createConditionalAccessPolicy": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Captures intent only. Conditional Access policies are not created by this ARM template."
      }
    },
    "conditionalAccessPolicyDisplayName": {
      "type": "string",
      "defaultValue": "Exclude MSP from MFA for Azure management apps",
      "metadata": {
        "description": "Display name for the Conditional Access policy (intent only)."
      }
    }
  },
  "variables": {
    "mspRegistrationName": "[guid(parameters('mspOfferName'))]",
    "mspAssignmentName": "[guid(parameters('mspOfferName'))]",
    "marketplacePlan": {
      "name": "[parameters('marketplacePlanId')]",
      "product": "[parameters('marketplaceOfferId')]",
      "publisher": "[parameters('marketplacePublisherId')]",
      "version": "[parameters('marketplacePlanVersion')]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.ManagedServices/registrationDefinitions",
      "apiVersion": "2019-06-01",
      "name": "[variables('mspRegistrationName')]",
      "properties": {
        "registrationDefinitionName": "[parameters('mspOfferName')]",
        "description": "[parameters('mspOfferDescription')]",
        "managedByTenantId": "[parameters('managedByTenantId')]",
        "authorizations": "[parameters('authorizations')]"
      },
      "plan": "[if(equals(parameters('marketplaceOffer'), 'Yes'), variables('marketplacePlan'), json('null'))]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "[concat('lighthouse-assignment-', copyIndex())]",
      "location": "[deployment().location]",
      "subscriptionId": "[parameters('targetSubscriptions')[copyIndex()]]",
      "dependsOn": [
        "[resourceId('Microsoft.ManagedServices/registrationDefinitions', variables('mspRegistrationName'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "parameters": {
          "mspRegistrationId": {
            "value": "[resourceId('Microsoft.ManagedServices/registrationDefinitions', variables('mspRegistrationName'))]"
          },
          "mspAssignmentName": {
            "value": "[variables('mspAssignmentName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "mspRegistrationId": {
              "type": "string"
            },
            "mspAssignmentName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedServices/registrationAssignments",
              "apiVersion": "2019-06-01",
              "name": "[parameters('mspAssignmentName')]",
              "properties": {
                "registrationDefinitionId": "[parameters('mspRegistrationId')]"
              }
            }
          ]
        }
      },
      "copy": {
        "name": "subscriptionCopy",
        "count": "[length(parameters('targetSubscriptions'))]"
      }
    }
  ],
  "outputs": {
    "mspRegistrationDefinitionId": {
      "type": "string",
      "value": "[resourceId('Microsoft.ManagedServices/registrationDefinitions', variables('mspRegistrationName'))]"
    },
    "mspOfferName": {
      "type": "string",
      "value": "[parameters('mspOfferName')]"
    },
    "targetedSubscriptionCount": {
      "type": "int",
      "value": "[length(parameters('targetSubscriptions'))]"
    },
    "targetedSubscriptions": {
      "type": "array",
      "value": "[parameters('targetSubscriptions')]"
    },
    "authorizations": {
      "type": "array",
      "value": "[parameters('authorizations')]"
    },
    "marketplace": {
      "type": "object",
      "value": "[if(equals(parameters('marketplaceOffer'), 'Yes'), variables('marketplacePlan'), json('{\"offer\":\"No marketplace offer\"}'))]"
    },
    "conditionalAccessRequested": {
      "type": "bool",
      "value": "[parameters('createConditionalAccessPolicy')]"
    },
    "conditionalAccessPolicyDisplayName": {
      "type": "string",
      "value": "[if(parameters('createConditionalAccessPolicy'), parameters('conditionalAccessPolicyDisplayName'), 'Conditional access policy not requested')]"
    }
  }
}
