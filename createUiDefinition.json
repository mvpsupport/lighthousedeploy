{
  "$schema": "https://schema.management.azure.com/schemas/2021-09-01/uiDefinition.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "1.0.0",
  "parameters": {
    "basics": [
      {
        "name": "offerName",
        "type": "Microsoft.Common.TextBox",
        "label": "Delegation name",
        "defaultValue": "Xcelocloud Lighthouse Delegation",
        "constraints": {
          "required": true,
          "minLength": 3,
          "maxLength": 64
        }
      },
      {
        "name": "offerDescription",
        "type": "Microsoft.Common.TextBox",
        "label": "Delegation description",
        "defaultValue": "Delegated Azure management via Azure Lighthouse",
        "constraints": {
          "required": true,
          "minLength": 3,
          "maxLength": 256
        }
      }
    ],
    "steps": [
      {
        "name": "partnerInfo",
        "label": "Partner information",
        "elements": [
          {
            "name": "infoBox",
            "type": "Microsoft.Common.InfoBox",
            "options": {
              "icon": "Info",
              "text": "Azure Lighthouse enables cross-tenant management. You'll delegate access from this subscription to a partner tenant, allowing specified users or groups in the partner tenant to manage resources here."
            }
          },
          {
            "name": "tenantIdLabel",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "Partner Tenant ID"
            }
          },
          {
            "name": "managedByTenantIdDisplay",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "fc6f8abc-0ae4-4406-abeb-4eb1ca6e07a1",
              "link": {
                "label": "",
                "uri": ""
              }
            }
          },
          {
            "name": "tenantIdNote",
            "type": "Microsoft.Common.InfoBox",
            "options": {
              "icon": "Info",
              "text": "This delegation is pre-configured for the partner tenant shown above. If you need to delegate to a different partner, please contact your service provider."
            }
          }
        ]
      },
      {
        "name": "permissions",
        "label": "Access & Permissions",
        "elements": [
          {
            "name": "authorizationsSection",
            "type": "Microsoft.Common.Section",
            "label": "Pre-configured partner access",
            "elements": [
              {
                "name": "authorizationInfo",
                "type": "Microsoft.Common.InfoBox",
                "options": {
                  "icon": "Info",
                  "text": "This delegation grants Support Request Contributor access to two partner groups for managing support tickets and requests in your subscription."
                }
              },
              {
                "name": "auth1Text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "• Helpdesk Support - Support Request Contributor"
                }
              },
              {
                "name": "auth2Text",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "• Partner Admin - Support Request Contributor"
                }
              },
              {
                "name": "roleInfo",
                "type": "Microsoft.Common.InfoBox",
                "options": {
                  "icon": "Info",
                  "text": "Support Request Contributor role allows the partner to create and manage support tickets but does not grant access to modify your Azure resources."
                }
              }
            ]
          },
          {
            "name": "conditionalAccessSection",
            "type": "Microsoft.Common.Section",
            "label": "Conditional Access policy",
            "elements": [
              {
                "name": "conditionalAccessInfo",
                "type": "Microsoft.Common.InfoBox",
                "options": {
                  "icon": "Info",
                  "text": "A Conditional Access policy will require MFA for Azure portal, Azure management, and Microsoft Graph while excluding users from the MSP tenant (fc6f8abc-0ae4-4406-abeb-4eb1ca6e07a1). Session controls will be left as none."
                }
              }
            ]
          }
        ]
      },
      {
        "name": "review",
        "label": "Review + Create",
        "elements": [
          {
            "name": "reviewSection",
            "type": "Microsoft.Common.Section",
            "label": "Summary",
            "elements": [
              {
                "name": "summaryInfo",
                "type": "Microsoft.Common.InfoBox",
                "options": {
                  "icon": "Info",
                  "text": "Review your Lighthouse delegation settings. Once deployed, the partner tenant will have access to manage resources in this subscription according to the roles you've assigned."
                }
              },
              {
                "name": "delegationName",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "[concat('Delegation: ', basics('offerName'))]"
                }
              },
              {
                "name": "tenantId",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "Partner Tenant: fc6f8abc-0ae4-4406-abeb-4eb1ca6e07a1"
                }
              },
              {
                "name": "authCount",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "Authorizations configured: 2"
                }
              },
              {
                "name": "auth1",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "  • Helpdesk Support: Support Request Contributor"
                }
              },
              {
                "name": "auth2",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "  • Partner Admin: Support Request Contributor"
                }
              },
              {
                "name": "caSummary",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "Conditional Access: MFA required for Azure portal, Azure management, and Microsoft Graph (MSP tenant excluded)"
                }
              }
            ]
          }
        ]
      }
    ],
    "outputs": {
      "mspOfferName": "[basics('offerName')]",
      "mspOfferDescription": "[basics('offerDescription')]",
      "managedByTenantId": "fc6f8abc-0ae4-4406-abeb-4eb1ca6e07a1",
      "authorizations": [
        {
          "principalId": "ac16bf33-cebb-44ea-b8d2-30650cf35bd2",
          "roleDefinitionId": "cfd33db0-3dd1-45e3-aa9d-cdbdf3b6f24e",
          "principalIdDisplayName": "Helpdesk Support"
        },
        {
          "principalId": "3a829362-01c3-4bda-b6a2-fcbbb32169d0",
          "roleDefinitionId": "cfd33db0-3dd1-45e3-aa9d-cdbdf3b6f24e",
          "principalIdDisplayName": "Partner Admin"
        }
      ],
      "marketplaceOffer": "No",
      "marketplacePublisherId": "marketplace-test",
      "marketplaceOfferId": "xc-partner-support-offering",
      "marketplacePlanId": "xcpartner",
      "marketplacePlanVersion": "2.0.0",
      "conditionalAccessPolicyName": "Exclude MSP tenant users from MFA",
      "createConditionalAccessPolicy": true
    }
  }
}
